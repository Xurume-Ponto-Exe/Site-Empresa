<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Segurança</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="index.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
</head>
<body>

    <div id="notification-container"></div>
    <div class="overlay"></div>
    
    <button id="menu-toggle-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
    </button>

    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="assets/mono-pbMarca-Belfort-Engenharia.png" alt="Logo Belfort Engenharia" class="logo-light">
                <img src="assets/mono-brancaMarca-Belfort-Engenharia (1).png" alt="Logo Belfort Engenharia" class="logo-dark">
            </div>
            <nav class="sidebar-nav">
                <a href="#" class="active" onclick="showPage('epi')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg> EPIs
                </a>
                <a href="#" onclick="showPage('obras')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect><rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect><line x1="6" y1="6" x2="6.01" y2="6"></line><line x1="6" y1="18" x2="6.01" y2="18"></line></svg> Obras
                </a>
                <a href="#" onclick="showPage('documentos')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg> Documentos
                </a>
                <a href="#" onclick="showPage('notificacoes')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg> Notificações
                </a>
            </nav>
            <div class="theme-toggle-container">
                <svg class="theme-icon icon-sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                <button id="btn-dark-mode-toggle"></button>
                <svg class="theme-icon icon-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </div>
        </aside>

        <main class="content">
            <div id="epi-page" class="page-content active">
                <div class="card">
                    <h2 id="epi-form-title">Cadastro de EPI</h2>
                    <div class="form-group"> <label for="descricao-epi">Descrição do EPI</label> <input type="text" id="descricao-epi"> </div>
                    <div class="form-group"> <label for="data-entrega-epi">Data de entrega</label> <input type="date" id="data-entrega-epi"> </div>
                    <div class="form-group"> <label for="tempo-troca">Tempo de troca (dias)</label> <input type="number" id="tempo-troca" inputmode="numeric"> </div>
                    <div class="form-group"> <label for="data-troca">Data da troca</label> <input type="date" id="data-troca"> </div>
                    <div class="btn-group"> <button id="btn-salvar-epi" onclick="salvarEpi()">Cadastrar EPI</button> <button class="btn-secondary" onclick="toggleView('EPIs')">Ver Cadastrados</button> </div>
                    <div id="epis-view-container" class="view-container" style="display:none;">
                        <div class="search-bar form-group">
                            <label for="busca-epi">Buscar EPI</label>
                            <input type="text" id="busca-epi" onkeyup="atualizarVisualizacao('EPIs')" placeholder="Digite a descrição para filtrar...">
                        </div>
                        <div id="epis-cadastrados-view" class="cadastros-view"></div>
                    </div>
                </div>
            </div>
            <div id="obras-page" class="page-content">
                 <div class="card">
                    <h2 id="obra-form-title">Cadastro de Obra</h2>
                    <div class="form-group"> <label for="desc-obra">Descrição da Obra</label> <input type="text" id="desc-obra"> </div>
                    <div class="form-group"> <label for="data-entrega-obra">Data da entrega da obra</label> <input type="date" id="data-entrega-obra"> </div>
                    <div class="form-group"> <label for="data-manutencao">Próxima manutenção</label> <input type="date" id="data-manutencao"> </div>
                    <div class="btn-group"> <button id="btn-salvar-obra" onclick="salvarObra()">Cadastrar Obra</button> <button class="btn-secondary" onclick="toggleView('Obras')">Ver Cadastradas</button> </div>
                    <div id="obras-view-container" class="view-container" style="display:none;">
                        <div class="search-bar form-group">
                            <label for="busca-obras">Buscar Obra</label>
                            <input type="text" id="busca-obras" onkeyup="atualizarVisualizacao('Obras')" placeholder="Digite a descrição para filtrar...">
                        </div>
                        <div id="obras-cadastradas-view" class="cadastros-view"></div>
                    </div>
                </div>
            </div>
            <div id="documentos-page" class="page-content">
                <div class="card">
                    <h2>Atualizar Documentos da Obra</h2>
                    <div class="form-group">
                        <label for="doc-nome-obra">Selecione a Obra para atualizar</label>
                        <input type="text" id="doc-nome-obra" list="lista-obras" placeholder="Digite ou selecione o nome da obra" onchange="carregarDetalhesDaObra()">
                        <datalist id="lista-obras"></datalist>
                    </div>
                    <div class="document-grid">
                        <div class="checkbox-group"> <input type="checkbox" id="art-rrt-recebida"> <label for="art-rrt-recebida">ART / RRT Recebida</label> </div>
                        <div class="checkbox-group"> <input type="checkbox" id="alvara-emitido"> <label for="alvara-emitido">Alvará de Construção Emitido</label> </div>
                        <div class="checkbox-group"> <input type="checkbox" id="avcb-aprovado"> <label for="avcb-aprovado">AVCB / Bombeiros Aprovado</label> </div>
                        <div class="checkbox-group"> <input type="checkbox" id="habitese-emitido"> <label for="habitese-emitido">Habite-se Emitido</label> </div>
                        <div class="checkbox-group"> <input type="checkbox" id="nf-recebida"> <label for="nf-recebida">Nota Fiscal Recebida</label> </div>
                    </div>
                    <div class="form-group">
                        <label>Anexar Arquivos</label>
                        <div id="drop-zone">
                            <input type="file" id="file-input" multiple hidden accept=".png,.jpeg,.jpg,.pdf,.docx">
                            <div class="drop-zone-text">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                                <p>Arraste e solte ou clique para selecionar</p>
                                <span>PNG, JPG, PDF, DOCX</span>
                            </div>
                        </div>
                        <div id="file-list"></div>
                    </div>
                    <div class="btn-group"> <button id="btn-atualizar-docs" onclick="marcarEnvioDocumentos()">Atualizar Documentos</button> </div>
                </div>
            </div>
            <div id="notificacoes-page" class="page-content">
                <div class="card">
                    <h2 class="notifications-header">Itens Datados</h2>
                    <div class="notifications-columns">
                        <div class="notification-column">
                            <h3 class="column-title">EPIs</h3>
                            <div id="epi-notifications-list" class="item-list"></div>
                        </div>
                        <div class="notification-column">
                            <h3 class="column-title">Obras</h3>
                            <div id="obras-notifications-list" class="item-list"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="notification-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Opções de Notificação</h3>
                <button class="close-button" onclick="fecharModalNotificacao()">&times;</button>
            </div>
            <div class="modal-body">
                <p><strong>Item:</strong> <span id="modal-item-descricao"></span></p>
                <p><strong>Vencimento:</strong> <span id="modal-item-data"></span></p>
            </div>
            <div class="modal-actions">
                <button id="modal-btn-email">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                    Email
                </button>
                <button id="modal-btn-whatsapp">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                    WhatsApp
                </button>
            </div>
        </div>
    </div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyAqSq3BqXDr7t4vGRFLm96YJKt5mlvVIwU",
      authDomain: "belfort-gerenciador.firebaseapp.com",
      projectId: "belfort-gerenciador",
      storageBucket: "belfort-gerenciador.appspot.com",
      messagingSenderId: "570427844767",
      appId: "1:570427844767:web:ce2b81fd6ebc84e04d5aaa"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    const ARQUIVO_EPI = "epis";
    const ARQUIVO_OBRA = "obras";
    let modoEdicao = { ativo: false, tipo: null, id: null };
    let itemNotificacaoAtual = null;
    let newFiles = [];
    let existingFiles = [];

    function showNotification(message, type = 'info') {
        const container = document.getElementById('notification-container');
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        container.appendChild(notification);
        setTimeout(() => notification.remove(), 5000);
    }

    function formatarDataParaSalvar(dataString) {
        if (!dataString) return "";
        const [ano, mes, dia] = dataString.split('-');
        return `${dia}/${mes}/${ano}`;
    }

    function formatarDataParaInput(dataString) {
        if (!dataString || !dataString.includes('/')) return "";
        const [dia, mes, ano] = dataString.split('/');
        return `${ano}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
    }

    function getInput(id) { return document.getElementById(id); }

    async function enviarConfirmacaoPorEmail(action, details) {
        try {
            const response = await fetch('/.netlify/functions/send-confirmation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, details }),
            });
            if (!response.ok) throw new Error('Falha na resposta da função.');
            showNotification("Notificação por email enviada!", "info");
        } catch (error) {
            console.error('Erro ao enviar email:', error);
            showNotification("Falha ao enviar email.", "error");
        }
    }

    async function excluirItem(tipo, id, descricao) {
        const collectionName = tipo === 'EPIs' ? ARQUIVO_EPI : ARQUIVO_OBRA;
        const nomeItem = tipo === 'EPIs' ? 'EPI' : 'Obra';
        
        if (confirm(`Tem certeza que deseja excluir ${nomeItem}: "${descricao}"?`)) {
            try {
                await db.collection(collectionName).doc(id).delete();
                showNotification(`${nomeItem} excluído com sucesso!`, 'success');
                atualizarVisualizacao(tipo);
            } catch (error) {
                showNotification(`Erro ao excluir o ${nomeItem}.`, 'error');
            }
        }
    }
    
    async function salvarEpi() {
        try {
            const epi = {
                descricao: getInput('descricao-epi').value.trim(),
                data_entrega: formatarDataParaSalvar(getInput('data-entrega-epi').value),
                tempo_troca_dias: parseInt(getInput('tempo-troca').value, 10),
                data_troca: formatarDataParaSalvar(getInput('data-troca').value)
            };
            if (!epi.descricao || !epi.data_entrega || isNaN(epi.tempo_troca_dias) || !epi.data_troca) throw new Error("Preencha todos os campos do EPI.");

            const collectionRef = db.collection(ARQUIVO_EPI);
            if (modoEdicao.ativo && modoEdicao.tipo === 'EPIs') {
                await collectionRef.doc(modoEdicao.id).update(epi);
                showNotification("EPI atualizado com sucesso!", 'success');
            } else {
                await collectionRef.add(epi);
                showNotification("EPI cadastrado com sucesso!", 'success');
            }
            resetarFormulario('EPIs');
            atualizarVisualizacao('EPIs');
        } catch (e) {
            showNotification(`Erro: ${e.message}`, 'error');
        }
    }

    async function salvarObra() {
        try {
            const obraData = {
                descricao: getInput('desc-obra').value.trim(),
                data_entrega_obra: formatarDataParaSalvar(getInput('data-entrega-obra').value),
                data_proxima_manutencao: formatarDataParaSalvar(getInput('data-manutencao').value),
            };
            if (!obraData.descricao || !obraData.data_entrega_obra || !obraData.data_proxima_manutencao) throw new Error("Preencha todos os campos da Obra.");

            const collectionRef = db.collection(ARQUIVO_OBRA);
            if (modoEdicao.ativo && modoEdicao.tipo === 'Obras') {
                const docRef = collectionRef.doc(modoEdicao.id);
                await docRef.update(obraData);
                showNotification("Obra atualizada!", 'success');
            } else {
                Object.assign(obraData, {
                    doc_art_rrt: false, doc_alvara: false, doc_avcb: false, doc_habitese: false, doc_nf: false, anexos: []
                });
                await collectionRef.add(obraData);
                showNotification("Obra cadastrada!", 'success');
            }
            resetarFormulario('Obras');
            atualizarVisualizacao('Obras');
        } catch (e) {
            showNotification(`Erro: ${e.message}`, 'error');
        }
    }

    async function editarItem(tipo, id) {
        const pageId = tipo === 'EPIs' ? 'epi' : 'obras';
        const collectionName = tipo === 'EPIs' ? ARQUIVO_EPI : ARQUIVO_OBRA;
        
        const doc = await db.collection(collectionName).doc(id).get();
        if (!doc.exists) return;
        
        const item = doc.data();
        modoEdicao = { ativo: true, tipo, id };
        
        showPage(pageId);
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        if (tipo === 'EPIs') {
            getInput('descricao-epi').value = item.descricao;
            getInput('data-entrega-epi').value = formatarDataParaInput(item.data_entrega);
            getInput('tempo-troca').value = item.tempo_troca_dias;
            getInput('data-troca').value = formatarDataParaInput(item.data_troca);
            getInput('epi-form-title').textContent = "Editando EPI";
            getInput('btn-salvar-epi').textContent = "Salvar Alterações";
        } else {
            getInput('desc-obra').value = item.descricao;
            getInput('data-entrega-obra').value = formatarDataParaInput(item.data_entrega_obra);
            getInput('data-manutencao').value = formatarDataParaInput(item.data_proxima_manutencao);
            getInput('obra-form-title').textContent = "Editando Obra";
            getInput('btn-salvar-obra').textContent = "Salvar Alterações";
        }
    }
    
    function resetarFormulario(tipo) {
        modoEdicao = { ativo: false, tipo: null, id: null };
        if (tipo === 'EPIs') {
            ['descricao-epi', 'data-entrega-epi', 'tempo-troca', 'data-troca'].forEach(id => getInput(id).value = '');
            getInput('epi-form-title').textContent = "Cadastro de EPI";
            getInput('btn-salvar-epi').textContent = "Cadastrar EPI";
        } else if (tipo === 'Obras') {
            ['desc-obra', 'data-entrega-obra', 'data-manutencao'].forEach(id => getInput(id).value = '');
            getInput('obra-form-title').textContent = "Cadastro de Obra";
            getInput('btn-salvar-obra').textContent = "Cadastrar Obra";
        } else if (tipo === 'Documentos') {
            getInput('doc-nome-obra').value = '';
            ['art-rrt-recebida', 'alvara-emitido', 'avcb-aprovado', 'habitese-emitido', 'nf-recebida'].forEach(id => getInput(id).checked = false);
            newFiles = [];
            existingFiles = [];
            renderFileList();
        }
    }

    function toggleView(tipo) {
        const containerId = tipo === 'EPIs' ? 'epis-view-container' : 'obras-view-container';
        const container = getInput(containerId);
        container.style.display = container.style.display === 'block' ? 'none' : 'block';
        if (container.style.display === 'block') {
            atualizarVisualizacao(tipo);
        }
    }

    async function atualizarVisualizacao(tipo) {
        const collectionName = tipo === 'EPIs' ? ARQUIVO_EPI : ARQUIVO_OBRA;
        const viewId = tipo === 'EPIs' ? 'epis-cadastrados-view' : 'obras-cadastradas-view';
        const buscaId = tipo === 'EPIs' ? 'busca-epi' : 'busca-obras';
        
        const viewElement = getInput(viewId);
        const termoBusca = getInput(buscaId).value.toLowerCase();
        viewElement.innerHTML = '<p style="text-align: center;">Carregando...</p>';

        try {
            const snapshot = await db.collection(collectionName).orderBy("descricao").get();
            const dados = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const dadosFiltrados = dados.filter(item => !termoBusca || item.descricao.toLowerCase().includes(termoBusca));
            viewElement.innerHTML = '';

            if (dadosFiltrados.length === 0) {
                viewElement.innerHTML = `<p style="text-align: center;">Nenhum item encontrado.</p>`;
                return;
            }

            dadosFiltrados.forEach(item => {
                const itemContainer = document.createElement('div');
                itemContainer.className = 'item-cadastrado';
                let bodyContent = '';
                
                if (tipo === 'Obras') {
                    bodyContent += `<p><strong>Data entrega obra:</strong> ${item.data_entrega_obra || 'N/A'}</p>`;
                    bodyContent += `<p><strong>Próxima manutenção:</strong> ${item.data_proxima_manutencao || 'N/A'}</p>`;
                    if (item.anexos && item.anexos.length > 0) {
                        const linksAnexos = item.anexos.map(anexo => `<li><a href="${anexo.url}" target="_blank">${anexo.name}</a></li>`).join('');
                        bodyContent += `<div class="anexos-view"><strong>Anexos:</strong><ul>${linksAnexos}</ul></div>`;
                    }
                } else {
                     bodyContent += `<p><strong>Data de Entrega:</strong> ${item.data_entrega || 'N/A'}</p>`;
                     bodyContent += `<p><strong>Tempo de Troca:</strong> ${item.tempo_troca_dias || 'N/A'} dias</p>`;
                     bodyContent += `<p><strong>Próxima Troca:</strong> ${item.data_troca || 'N/A'}</p>`;
                }
                
                itemContainer.innerHTML = `
                    <div class="item-header">
                        <h4>${item.descricao}</h4>
                        <div class="item-actions">
                             <button class="btn-notify" title="Notificar"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg></button>
                            <button class="btn-edit" title="Editar"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                            <button class="btn-delete" title="Excluir"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button>
                        </div>
                    </div>
                    <div class="item-body">${bodyContent}</div>`;

                itemContainer.querySelector('.btn-notify').addEventListener('click', () => abrirModalNotificacao(tipo, item.id));
                itemContainer.querySelector('.btn-edit').addEventListener('click', () => editarItem(tipo, item.id));
                itemContainer.querySelector('.btn-delete').addEventListener('click', () => excluirItem(tipo, item.id, item.descricao));
                viewElement.appendChild(itemContainer);
            });
        } catch (error) {
            viewElement.innerHTML = `<p style="text-align: center; color: var(--cor-erro);">Erro ao carregar dados.</p>`;
        }
    }

    async function marcarEnvioDocumentos() {
        // (Lógica de upload e atualização de documentos aqui)
    }

    function toggleDarkMode() {
        document.body.classList.toggle('dark-theme');
        localStorage.setItem('theme', document.body.classList.contains('dark-theme') ? 'dark' : 'light');
    }
    
    function showPage(pageId) {
        document.querySelectorAll('.page-content.active, .sidebar-nav a.active').forEach(el => el.classList.remove('active'));
        getInput(pageId + '-page').classList.add('active');
        document.querySelector(`.sidebar-nav a[onclick*="'${pageId}'"]`).classList.add('active');
        
        ['EPIs', 'Obras', 'Documentos'].forEach(resetarFormulario);

        if (pageId === 'documentos') popularListaObras();
        if (pageId === 'notificacoes') carregarNotificacoes();

        const sidebar = document.querySelector('.sidebar');
        if (sidebar.classList.contains('open')) {
            sidebar.classList.remove('open');
            document.querySelector('.overlay').classList.remove('active');
        }
    }

    async function carregarNotificacoes() {
        const epiList = document.getElementById('epi-notifications-list');
        const obraList = document.getElementById('obras-notifications-list');
        epiList.innerHTML = '<p>Carregando...</p>';
        obraList.innerHTML = '<p>Carregando...</p>';

        try {
            const epiSnapshot = await db.collection(ARQUIVO_EPI).orderBy("descricao").get();
            const epis = epiSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            epiList.innerHTML = '';
            if (epis.length > 0) {
                epis.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'notification-item';
                    itemDiv.innerHTML = `<p><strong>${item.descricao}</strong></p><p>Próxima troca em: ${item.data_troca}</p>`;
                    itemDiv.onclick = () => editarItem('EPIs', item.id);
                    epiList.appendChild(itemDiv);
                });
            } else {
                epiList.innerHTML = '<p>Nenhum EPI cadastrado.</p>';
            }

            const obraSnapshot = await db.collection(ARQUIVO_OBRA).orderBy("descricao").get();
            const obras = obraSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            obraList.innerHTML = '';
            if (obras.length > 0) {
                obras.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'notification-item';
                    itemDiv.innerHTML = `<p><strong>${item.descricao}</strong></p><p>Próxima manutenção em: ${item.data_proxima_manutencao}</p>`;
                    itemDiv.onclick = () => editarItem('Obras', item.id);
                    obraList.appendChild(itemDiv);
                });
            } else {
                obraList.innerHTML = '<p>Nenhuma obra cadastrada.</p>';
            }
        } catch (error) {
            epiList.innerHTML = '<p style="color: var(--cor-erro)">Falha ao carregar EPIs.</p>';
            obraList.innerHTML = '<p style="color: var(--cor-erro)">Falha ao carregar obras.</p>';
        }
    }

    async function abrirModalNotificacao(tipo, id) {
        const collectionName = tipo === 'EPIs' ? ARQUIVO_EPI : ARQUIVO_OBRA;
        const doc = await db.collection(collectionName).doc(id).get();
        if (!doc.exists) return showNotification("Item não encontrado.", "error");
        
        itemNotificacaoAtual = doc.data();
        const descricao = itemNotificacaoAtual.descricao;
        const dataVencimento = tipo === 'EPIs' ? itemNotificacaoAtual.data_troca : itemNotificacaoAtual.data_proxima_manutencao;

        getInput('modal-item-descricao').textContent = descricao;
        getInput('modal-item-data').textContent = dataVencimento;

        getInput('modal-btn-email').onclick = () => {
            const subject = `Lembrete de Vencimento: ${descricao}`;
            const details = `Lembrete para o item: ${descricao}\nData de Vencimento: ${dataVencimento}`;
            enviarConfirmacaoPorEmail(subject, details);
            fecharModalNotificacao();
        };

        getInput('modal-btn-whatsapp').onclick = () => {
            enviarNotificacaoWhatsApp(descricao, dataVencimento);
            fecharModalNotificacao();
        };

        getInput('notification-modal').classList.add('open');
    }

    function fecharModalNotificacao() {
        getInput('notification-modal').classList.remove('open');
        itemNotificacaoAtual = null;
    }

    function enviarNotificacaoWhatsApp(descricao, dataVencimento) {
        const numero = '5598992220706';
        const mensagem = `Lembrete de Vencimento:\n\nItem: *${descricao}*\nVencimento: *${dataVencimento}*`;
        const url = `https://wa.me/${numero}?text=${encodeURIComponent(mensagem)}`;
        window.open(url, '_blank');
    }
    
    window.onload = () => {
        if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-theme');
        getInput('btn-dark-mode-toggle').addEventListener('click', toggleDarkMode);
        
        const menuButton = getInput('menu-toggle-btn');
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.querySelector('.overlay');
        
        menuButton.addEventListener('click', () => {
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        });
        overlay.addEventListener('click', () => {
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
        });

        getInput('notification-modal').addEventListener('click', (event) => {
            if (event.target === event.currentTarget) fecharModalNotificacao();
        });
        
        showPage('epi');
    };
</script>

</body>
</html>